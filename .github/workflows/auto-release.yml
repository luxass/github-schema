name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - github-schema.graphql
      - src/github-schema.ts

jobs:
  auto-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    if: |
      github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'update-github-graphql-schema'
      && github.repository == 'luxass/github-schema' && (github.event.pull_request.user.login == 'luxass' || github.event.pull_request.user.login == 'github-actions[bot]')
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.AUTO_RELEASE_TOKEN }}

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          package-manager-cache: false

      - name: install dependencies
        run: pnpm install

      - name: build
        run: pnpm run build

      - name: create tag and release
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.AUTO_RELEASE_TOKEN }}
          GH_TOKEN: ${{ secrets.AUTO_RELEASE_TOKEN }}
        run: |
          set -euo pipefail

          # Read current version
          CURRENT_VERSION=$(jq -r '.version' package.json)

          # Validate semver
          if ! [[ $CURRENT_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Current version ($CURRENT_VERSION) is not in major.minor.patch format."
            exit 1
          fi

          if ! [[ "${PR_NUMBER:-}" =~ ^[0-9]+$ ]]; then
            echo "âŒ Invalid PR number: ${PR_NUMBER:-}" >&2
            exit 1
          fi

          # Get list of commits for this PR
          # mapfile will read base64-encoded messages so multi-line messages stay intact
          mapfile -t commit_messages < <(gh api "repos/luxass/github-schema/pulls/$PR_NUMBER/commits" --jq -r '.[].commit.message | @base64')

          # Determine bump level: none -> patch by default; major > minor > patch
          BUMP_LEVEL="none"

          echo "Checking commits for PR #$PR_NUMBER to determine bump type..."

          for cm_b64 in "${commit_messages[@]}"; do
            commit_message=$(printf '%s' "$cm_b64" | base64 --decode)

            # Get the first line
            header=$(printf "%s" "$commit_message" | sed -n '1p')

            # Detect breaking change via explicit marker or conventional commit bang (!)
            if printf "%s" "$commit_message" | grep -q "BREAKING CHANGE" || printf "%s" "$header" | grep -Eq '^[^:]+(\([^)]*\))?\!:'; then
              echo "Found breaking change in a commit (redacted)"
              BUMP_LEVEL="major"
              break
            fi

            # Feature
            if printf "%s" "$header" | grep -Eq '^[fF]eat(\(|:)' ; then
              if [ "$BUMP_LEVEL" != "major" ]; then
                BUMP_LEVEL="minor"
              fi
            fi

            # Fix
            if printf "%s" "$header" | grep -Eq '^[fF]ix(\(|:)' ; then
              if [ "$BUMP_LEVEL" = "none" ]; then
                BUMP_LEVEL="patch"
              fi
            fi
          done

          # Default behavior when nothing matched: patch (so releases still happen)
          if [ "$BUMP_LEVEL" = "none" ]; then
            echo "No conventional commit bump-type detected. Defaulting to patch."
            BUMP_LEVEL="patch"
          fi

          echo "Decided bump level: $BUMP_LEVEL"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          case "$BUMP_LEVEL" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
            *)
              echo "Unknown bump level: $BUMP_LEVEL"
              exit 1
              ;;
          esac

          echo "Current version: $CURRENT_VERSION -> New version: $NEW_VERSION"

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          npx bumpp "$NEW_VERSION" --commit --tag --push --yes
